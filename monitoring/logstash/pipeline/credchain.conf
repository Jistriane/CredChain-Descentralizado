input {
  beats {
    port => 5044
  }
}

filter {
  if [fields][service] == "credchain-api-gateway" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{DATA:logger} - %{GREEDYDATA:message}" }
    }
    
    if [message] =~ /credit.*score/ {
      mutate {
        add_tag => [ "credit_score" ]
      }
    }
    
    if [message] =~ /payment/ {
      mutate {
        add_tag => [ "payment" ]
      }
    }
    
    if [message] =~ /error|exception/ {
      mutate {
        add_tag => [ "error" ]
      }
    }
  }
  
  if [fields][service] == "credchain-eliza-runtime" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{DATA:agent} - %{GREEDYDATA:message}" }
    }
    
    if [agent] =~ /orchestrator/ {
      mutate {
        add_tag => [ "orchestrator" ]
      }
    }
    
    if [agent] =~ /credit-analyzer/ {
      mutate {
        add_tag => [ "credit_analyzer" ]
      }
    }
    
    if [agent] =~ /fraud-detector/ {
      mutate {
        add_tag => [ "fraud_detector" ]
      }
    }
  }
  
  if [fields][service] == "credchain-substrate-node" {
    grok {
      match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{DATA:component} - %{GREEDYDATA:message}" }
    }
    
    if [component] =~ /block/ {
      mutate {
        add_tag => [ "blockchain" ]
      }
    }
    
    if [component] =~ /pallet/ {
      mutate {
        add_tag => [ "pallet" ]
      }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "credchain-logs-%{+YYYY.MM.dd}"
  }
}
